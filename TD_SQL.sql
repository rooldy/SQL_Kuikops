CREATE SCHEMA HR;

SET search_path TO HR;

BEGIN TRANSACTION;

-- CRÉATION DE LA TABLE TD_TRAIN_CARTE
CREATE TABLE HR.TD_TRAIN_CARTE(
    CD_CARTE VARCHAR(5) NOT NULL,      
    TYPE_CARTE VARCHAR(20),             
    DESC_CARTE VARCHAR(100),            
    PRIX DECIMAL(20,9),                 
    CONSTRAINT PK_TRAINCARTE PRIMARY KEY (CD_CARTE)  
);

-- CRÉATION DE LA TABLE TD_TRAIN_CLIENT
CREATE TABLE HR.TD_TRAIN_CLIENT(
	CD_EMAIL INTEGER NOT NULL,
	LBL_EMAIL VARCHAR(100),
	NOM VARCHAR(20),
	PRENOM VARCHAR(20),
	DATE_DE_NAISSANCE DATE,
	ADRESSE VARCHAR(100),
	CONSTRAINT PK_TRAIN_CLIENT PRIMARY KEY(CD_EMAIL)
);

-- CRÉATION DE LA TABLE TD_TRAIN_PAYS
CREATE TABLE HR.TD_TRAIN_PAYS(
	CODE_PAYS VARCHAR(5) NOT NULL,
	NOM_PAYS VARCHAR(20),
	CONSTRAINT PK_TRAINPAYS PRIMARY KEY(CODE_PAYS)
);

-- CRÉATION DE LA TABLE TD_TYPE_TRAIN
CREATE TABLE HR.TD_TYPE_TRAIN(
	CD_TRAIN VARCHAR(20) NOT NULL,
	TYPE_TRAIN VARCHAR(50),
	NOMBRE_PLACE INTEGER,
	CONSTRAINT PK_TYPETRAIN PRIMARY KEY(CD_TRAIN)
);

-- CRÉATION DE LA TABLE TD_TRAIN_VILLE
CREATE TABLE HR.TD_TRAIN_VILLE(
	CD_VOYAGE VARCHAR(20) NOT NULL,
	VILLE_ORIGINE VARCHAR(50) NOT NULL,
	VILLE_DESTINATAIRE VARCHAR(50),
	CONSTRAINT PK_TRAINVILLE PRIMARY KEY(CD_VOYAGE)
);

-- CRÉATION DE LA TABLE TF_TRAIN_COMMANDE
CREATE TABLE HR.TF_TRAIN_COMMANDE(
	CD_COMMANDE INTEGER NOT NULL,
	CD_EMAIL INTEGER NOT NULL,
	CD_TRAIN VARCHAR(20),
	CD_VOYAGE VARCHAR(20) NOT NULL,
	CD_CARTE VARCHAR(5),
	QUANTITE INTEGER NOT NULL,
	DATE_ACHAT DATE,
	MONTANT DECIMAL(20,9) NOT NULL,
	DATE_VOYAGE DATE,
	CODE_PAYS VARCHAR(5),  -- Correspond à la taille de CODE_PAYS dans TD_TRAIN_PAYS
	CONSTRAINT FK_CMD_CLIENT FOREIGN KEY (CD_EMAIL) REFERENCES TD_TRAIN_CLIENT(CD_EMAIL),
	CONSTRAINT FK_CMD_TYPE FOREIGN KEY (CD_TRAIN) REFERENCES TD_TYPE_TRAIN(CD_TRAIN),
	CONSTRAINT FK_CMD_VILLE FOREIGN KEY (CD_VOYAGE) REFERENCES TD_TRAIN_VILLE(CD_VOYAGE),
	CONSTRAINT FK_CMD_CARTE FOREIGN KEY (CD_CARTE) REFERENCES TD_TRAIN_CARTE(CD_CARTE),
	CONSTRAINT FK_CMD_PAYS FOREIGN KEY (CODE_PAYS) REFERENCES TD_TRAIN_PAYS(CODE_PAYS)
);



 -- DDL for Table TD_TRAIN_CARTE
--------------------------------------------------------

Insert into HR.TD_TRAIN_CARTE (CD_CARTE,TYPE_CARTE,DESC_CARTE,PRIX) values ('CAJ','COMMERCIALE','CARTE AVANTAGE JEUNE','49');
Insert into HR.TD_TRAIN_CARTE (CD_CARTE,TYPE_CARTE,DESC_CARTE,PRIX) values ('CAS','COMMERCIALE','CARTE AVANTAGE SENIOR','49');
Insert into HR.TD_TRAIN_CARTE (CD_CARTE,TYPE_CARTE,DESC_CARTE,PRIX) values ('CAA','COMMERCIALE','CARTE AVANTAGE ADULTE','49');
Insert into HR.TD_TRAIN_CARTE (CD_CARTE,TYPE_CARTE,DESC_CARTE,PRIX) values ('CAW','COMMERCIALE','CARTE AVANTAGE WEEKEND','49');
Insert into HR.TD_TRAIN_CARTE (CD_CARTE,TYPE_CARTE,DESC_CARTE,PRIX) values ('CF','FIDELITE','CARTE DE FIDELITE','0');


-- DDL for Table TD_TRAIN_CLIENT
--------------------------------------------------------

Insert into HR.TD_TRAIN_CLIENT (CD_EMAIL,LBL_EMAIL,NOM,PRENOM,DATE_DE_NAISSANCE,ADRESSE) values ('23456','faure.dupont@gmail.com','FAURE','Dupont',to_date('16/05/93','DD/MM/RR'),null);
Insert into HR.TD_TRAIN_CLIENT (CD_EMAIL,LBL_EMAIL,NOM,PRENOM,DATE_DE_NAISSANCE,ADRESSE) values ('23457','briche.arnaud@gmail.com','BRICHE','arnaud',to_date('17/08/90','DD/MM/RR'),null);
Insert into HR.TD_TRAIN_CLIENT (CD_EMAIL,LBL_EMAIL,NOM,PRENOM,DATE_DE_NAISSANCE,ADRESSE) values ('23458','lamaire.patrick@outlook.com','LAMAIRE','patrick',to_date('01/01/93','DD/MM/RR'),null);
Insert into HR.TD_TRAIN_CLIENT (CD_EMAIL,LBL_EMAIL,NOM,PRENOM,DATE_DE_NAISSANCE,ADRESSE) values ('23459','simon.Laura@yahoo.com','SIMON','Laura',to_date('19/08/92','DD/MM/RR'),null);
Insert into HR.TD_TRAIN_CLIENT (CD_EMAIL,LBL_EMAIL,NOM,PRENOM,DATE_DE_NAISSANCE,ADRESSE) values ('23460','emeric.fabrice@gmail.com','EMERIC','Fabrice',to_date('25/02/89','DD/MM/RR'),null);
Insert into HR.TD_TRAIN_CLIENT (CD_EMAIL,LBL_EMAIL,NOM,PRENOM,DATE_DE_NAISSANCE,ADRESSE) values ('23461','ketouche.delphine@gmail.com','KETOUCHE','delphine',to_date('30/03/80','DD/MM/RR'),null);
Insert into HR.TD_TRAIN_CLIENT (CD_EMAIL,LBL_EMAIL,NOM,PRENOM,DATE_DE_NAISSANCE,ADRESSE) values ('23462','ebbar.christine@outlook.com','EBBAR','christine',to_date('22/08/79','DD/MM/RR'),null);
Insert into HR.TD_TRAIN_CLIENT (CD_EMAIL,LBL_EMAIL,NOM,PRENOM,DATE_DE_NAISSANCE,ADRESSE) values ('23463','lefebure.duy@gmail.com','LEFEBURE','duy',to_date('16/05/93','DD/MM/RR'),null);
Insert into HR.TD_TRAIN_CLIENT (CD_EMAIL,LBL_EMAIL,NOM,PRENOM,DATE_DE_NAISSANCE,ADRESSE) values ('23464','gernigon.vergini@yahoo.com','GERNIGON','vergini',to_date('07/11/85','DD/MM/RR'),null);
Insert into HR.TD_TRAIN_CLIENT (CD_EMAIL,LBL_EMAIL,NOM,PRENOM,DATE_DE_NAISSANCE,ADRESSE) values ('23465','mahop.camille@gmail.com','MAHOP','camille',to_date('20/12/87','DD/MM/RR'),null);
Insert into HR.TD_TRAIN_CLIENT (CD_EMAIL,LBL_EMAIL,NOM,PRENOM,DATE_DE_NAISSANCE,ADRESSE) values ('23466','piot.aurélie@gmail.com','PIOT','aurélie',to_date('26/05/93','DD/MM/RR'),null);


SELECT * FROM HR.TD_TRAIN_CLIENT;

--  DDL for Table TD_TRAIN_PAYS
--------------------------------------------------------

Insert into HR.TD_TRAIN_PAYS (CODE_PAYS,NOM_PAYS) values ('FR','France');
Insert into HR.TD_TRAIN_PAYS (CODE_PAYS,NOM_PAYS) values ('LU','Luxembourg');
Insert into HR.TD_TRAIN_PAYS (CODE_PAYS,NOM_PAYS) values ('BE','Belgique');

--  DDL for Table TD_TYPE_TRAIN
--------------------------------------------------------

Insert into HR.TD_TYPE_TRAIN (CD_TRAIN,TYPE_TRAIN,NOMBRE_PLACE) values ('TG','TGV INOUI','600');
Insert into HR.TD_TYPE_TRAIN (CD_TRAIN,TYPE_TRAIN,NOMBRE_PLACE) values ('OUI','OUIGO','500');
Insert into HR.TD_TYPE_TRAIN (CD_TRAIN,TYPE_TRAIN,NOMBRE_PLACE) values ('TR','TER','250');
Insert into HR.TD_TYPE_TRAIN (CD_TRAIN,TYPE_TRAIN,NOMBRE_PLACE) values ('EUR','Eurostar','600');
Insert into HR.TD_TYPE_TRAIN (CD_TRAIN,TYPE_TRAIN,NOMBRE_PLACE) values ('THA','Thalys','400');
Insert into HR.TD_TYPE_TRAIN (CD_TRAIN,TYPE_TRAIN,NOMBRE_PLACE) values ('INT','Intercités','500');

--  DDL for Table TD_TRAIN_VILLE
--------------------------------------------------------

Insert into HR.TD_TRAIN_VILLE (CD_VOYAGE,VILLE_ORIGINE,VILLE_DESTINATAIRE) values ('11','PARIS','TOULOUSE');
Insert into HR.TD_TRAIN_VILLE (CD_VOYAGE,VILLE_ORIGINE,VILLE_DESTINATAIRE) values ('89','LYON','MARSEILLE');
Insert into HR.TD_TRAIN_VILLE (CD_VOYAGE,VILLE_ORIGINE,VILLE_DESTINATAIRE) values ('41','TOURS','PARIS');
Insert into HR.TD_TRAIN_VILLE (CD_VOYAGE,VILLE_ORIGINE,VILLE_DESTINATAIRE) values ('21','LILLE','PARIS');
Insert into HR.TD_TRAIN_VILLE (CD_VOYAGE,VILLE_ORIGINE,VILLE_DESTINATAIRE) values ('15','PARIS','Bordeaux');
Insert into HR.TD_TRAIN_VILLE (CD_VOYAGE,VILLE_ORIGINE,VILLE_DESTINATAIRE) values ('51','Bordeaux','PARIS');

--  DDL for Table TF_TRAIN_COMMANDE
--------------------------------------------------------

Insert into HR.TF_TRAIN_COMMANDE (CD_COMMANDE,CD_EMAIL,CD_TRAIN,CD_VOYAGE,CD_CARTE,QUANTITE,DATE_ACHAT,MONTANT,DATE_VOYAGE,CODE_PAYS) values ('1000','23456','TG','11','CAJ','1',to_date('03/11/21','DD/MM/RR'),'80',to_date('01/02/20','DD/MM/RR'),null);
Insert into HR.TF_TRAIN_COMMANDE (CD_COMMANDE,CD_EMAIL,CD_TRAIN,CD_VOYAGE,CD_CARTE,QUANTITE,DATE_ACHAT,MONTANT,DATE_VOYAGE,CODE_PAYS) values ('1001','23457','OUI','89','CAS','1',to_date('04/10/21','DD/MM/RR'),'10',to_date('02/02/20','DD/MM/RR'),null);
Insert into HR.TF_TRAIN_COMMANDE (CD_COMMANDE,CD_EMAIL,CD_TRAIN,CD_VOYAGE,CD_CARTE,QUANTITE,DATE_ACHAT,MONTANT,DATE_VOYAGE,CODE_PAYS) values ('1002','23458','TR','41','CAA','1',to_date('05/09/21','DD/MM/RR'),'55',to_date('03/02/20','DD/MM/RR'),null);
Insert into HR.TF_TRAIN_COMMANDE (CD_COMMANDE,CD_EMAIL,CD_TRAIN,CD_VOYAGE,CD_CARTE,QUANTITE,DATE_ACHAT,MONTANT,DATE_VOYAGE,CODE_PAYS) values ('1003','23459','EUR','21','CAW','1',to_date('06/08/21','DD/MM/RR'),'100',to_date('04/02/20','DD/MM/RR'),null);
Insert into HR.TF_TRAIN_COMMANDE (CD_COMMANDE,CD_EMAIL,CD_TRAIN,CD_VOYAGE,CD_CARTE,QUANTITE,DATE_ACHAT,MONTANT,DATE_VOYAGE,CODE_PAYS) values ('1004','23460','THA','15','CF','1',to_date('07/07/21','DD/MM/RR'),'98',to_date('05/02/20','DD/MM/RR'),null);
Insert into HR.TF_TRAIN_COMMANDE (CD_COMMANDE,CD_EMAIL,CD_TRAIN,CD_VOYAGE,CD_CARTE,QUANTITE,DATE_ACHAT,MONTANT,DATE_VOYAGE,CODE_PAYS) values ('1005','23461','INT','51','CAJ','1',to_date('08/06/21','DD/MM/RR'),'66',to_date('06/02/20','DD/MM/RR'),null);
Insert into HR.TF_TRAIN_COMMANDE (CD_COMMANDE,CD_EMAIL,CD_TRAIN,CD_VOYAGE,CD_CARTE,QUANTITE,DATE_ACHAT,MONTANT,DATE_VOYAGE,CODE_PAYS) values ('1006','23462','TG','11','CAS','1',to_date('09/02/21','DD/MM/RR'),'80',to_date('07/02/20','DD/MM/RR'),null);
Insert into HR.TF_TRAIN_COMMANDE (CD_COMMANDE,CD_EMAIL,CD_TRAIN,CD_VOYAGE,CD_CARTE,QUANTITE,DATE_ACHAT,MONTANT,DATE_VOYAGE,CODE_PAYS) values ('1007','23463','OUI','89','CAA','1',to_date('10/04/21','DD/MM/RR'),'10',to_date('08/02/20','DD/MM/RR'),null);
Insert into HR.TF_TRAIN_COMMANDE (CD_COMMANDE,CD_EMAIL,CD_TRAIN,CD_VOYAGE,CD_CARTE,QUANTITE,DATE_ACHAT,MONTANT,DATE_VOYAGE,CODE_PAYS) values ('1008','23464','TR','41','CAW','1',to_date('11/09/21','DD/MM/RR'),'55',to_date('09/02/20','DD/MM/RR'),null);
Insert into HR.TF_TRAIN_COMMANDE (CD_COMMANDE,CD_EMAIL,CD_TRAIN,CD_VOYAGE,CD_CARTE,QUANTITE,DATE_ACHAT,MONTANT,DATE_VOYAGE,CODE_PAYS) values ('1009','23465','EUR','21','CF','1',to_date('12/01/21','DD/MM/RR'),'100',to_date('10/02/20','DD/MM/RR'),null);
Insert into HR.TF_TRAIN_COMMANDE (CD_COMMANDE,CD_EMAIL,CD_TRAIN,CD_VOYAGE,CD_CARTE,QUANTITE,DATE_ACHAT,MONTANT,DATE_VOYAGE,CODE_PAYS) values ('1010','23466','THA','15','CAJ','1',to_date('13/06/21','DD/MM/RR'),'98',to_date('11/02/20','DD/MM/RR'),null);
Insert into HR.TF_TRAIN_COMMANDE (CD_COMMANDE,CD_EMAIL,CD_TRAIN,CD_VOYAGE,CD_CARTE,QUANTITE,DATE_ACHAT,MONTANT,DATE_VOYAGE,CODE_PAYS) values ('1011','23456','TG','51','CAS','1',to_date('14/06/21','DD/MM/RR'),'66',to_date('12/02/20','DD/MM/RR'),null);
Insert into HR.TF_TRAIN_COMMANDE (CD_COMMANDE,CD_EMAIL,CD_TRAIN,CD_VOYAGE,CD_CARTE,QUANTITE,DATE_ACHAT,MONTANT,DATE_VOYAGE,CODE_PAYS) values ('1012','23457','OUI','11','CAA','1',to_date('15/03/21','DD/MM/RR'),'80',to_date('13/02/20','DD/MM/RR'),null);
Insert into HR.TF_TRAIN_COMMANDE (CD_COMMANDE,CD_EMAIL,CD_TRAIN,CD_VOYAGE,CD_CARTE,QUANTITE,DATE_ACHAT,MONTANT,DATE_VOYAGE,CODE_PAYS) values ('1013','23458','TR','89','CAW','1',to_date('16/05/21','DD/MM/RR'),'10',to_date('14/02/20','DD/MM/RR'),null);


COMMIT;

------------------------------------------- Questions ----------------------------------------------

-- Questions création de table et insertion des données :
-- 1. Créer les tables dans le schéma de votre base de donnée en respectant le lien de
-- clés primaires et étrangères.
-- 2. Insérer les données dans les tables (en utilisant les scripts .sql)
-- 2. Questions SQL :

-- 1. Affichez les commandes et les CD_EMAIL dont le montant d’achat est nettement
-- supérieur à 80.00 euros.

SELECT CD_COMMANDE, CD_EMAIL, MONTANT
FROM HR.TF_TRAIN_COMMANDE
WHERE MONTANT > 80.00;


-- 2. Affichez les adresses mail avec les cd_commande dont la date de voyage est
-- inférieure au 10/02/2020.

SELECT 
    TC.LBL_EMAIL, 
    TCOM.CD_COMMANDE 
FROM 
    HR.TD_TRAIN_CLIENT AS TC
JOIN 
    HR.TF_TRAIN_COMMANDE AS TCOM 
ON TCOM.CD_EMAIL = TC.CD_EMAIL
WHERE 
    TCOM.DATE_VOYAGE < TO_DATE('10/02/2020', 'DD/MM/YYYY');

-- 3. Calculez les doublons de cd_email de la table TF_TRAIN_COMMANDE.

SELECT 
    CD_EMAIL, 
    COUNT(*) AS Nombre_Doublons 
FROM 
    HR.TF_TRAIN_COMMANDE 
GROUP BY 
    CD_EMAIL 
HAVING 
    COUNT(*) > 1;


-- 4. Affichez les cd_email qui ont effectué au moins deux commandes.

SELECT
    CD_EMAIL
FROM 
    HR.TF_TRAIN_COMMANDE 
GROUP BY
    CD_EMAIL
HAVING
    COUNT(*) > 1;

-- 5. Sélectionnez les noms et les adresses mail des voyageurs qui ont effectué le trajet
-- Lyon<=>Marseille. f. Affichez le descriptif de la carte le type des train des
-- cd_commande de la tables tf_train_commande.

SELECT 
    TC.NOM,
    TC.LBL_EMAIL,
    TCA.DESC_CARTE,
    TT.TYPE_TRAIN
FROM 
    HR.TF_TRAIN_COMMANDE AS TCOM
JOIN 
    HR.TD_TRAIN_CLIENT AS TC ON TCOM.CD_EMAIL = TC.CD_EMAIL
JOIN 
    HR.TD_TRAIN_VILLE AS TV ON TCOM.CD_VOYAGE = TV.CD_VOYAGE
JOIN 
    HR.TD_TRAIN_CARTE AS TCA ON TCOM.CD_CARTE = TCA.CD_CARTE
JOIN 
    HR.TD_TYPE_TRAIN AS TT ON TCOM.CD_TRAIN = TT.CD_TRAIN
WHERE 
    (TV.VILLE_ORIGINE = 'LYON' AND TV.VILLE_DESTINATAIRE = 'MARSEILLE')
    OR (TV.VILLE_ORIGINE = 'MARSEILLE' AND TV.VILLE_DESTINATAIRE = 'LYON');


-- 6. Sélectionnez les noms, prénoms, adresse mail et les types de carte des personnes
-- qui ont effectué les deux trajets : PARIS<=>TOULOUSE et Bordeaux<=>PARIS.

SELECT 
    TC.NOM,
    TC.PRENOM,
    TC.LBL_EMAIL,
    TCA.TYPE_CARTE
FROM 
    HR.TF_TRAIN_COMMANDE AS TCOM
JOIN 
    HR.TD_TRAIN_CLIENT AS TC ON TCOM.CD_EMAIL = TC.CD_EMAIL
JOIN 
    HR.TD_TRAIN_VILLE AS TV ON TCOM.CD_VOYAGE = TV.CD_VOYAGE
JOIN 
    HR.TD_TRAIN_CARTE AS TCA ON TCOM.CD_CARTE = TCA.CD_CARTE
WHERE 
    (TV.VILLE_ORIGINE = 'PARIS' AND TV.VILLE_DESTINATAIRE = 'TOULOUSE')
    OR (TV.VILLE_ORIGINE = 'TOULOUSE' AND TV.VILLE_DESTINATAIRE = 'PARIS')
    OR (TV.VILLE_ORIGINE = 'BORDEAUX' AND TV.VILLE_DESTINATAIRE = 'PARIS')
    OR (TV.VILLE_ORIGINE = 'PARIS' AND TV.VILLE_DESTINATAIRE = 'BORDEAUX')
GROUP BY 
    TC.NOM,
    TC.PRENOM,
    TC.LBL_EMAIL,
    TCA.TYPE_CARTE
HAVING 
    COUNT(DISTINCT CASE 
        WHEN (TV.VILLE_ORIGINE = 'PARIS' AND TV.VILLE_DESTINATAIRE = 'TOULOUSE')
             OR (TV.VILLE_ORIGINE = 'TOULOUSE' AND TV.VILLE_DESTINATAIRE = 'PARIS')
        THEN 'PARIS-TOULOUSE'
        WHEN (TV.VILLE_ORIGINE = 'BORDEAUX' AND TV.VILLE_DESTINATAIRE = 'PARIS')
             OR (TV.VILLE_ORIGINE = 'PARIS' AND TV.VILLE_DESTINATAIRE = 'BORDEAUX')
        THEN 'BORDEAUX-PARIS'
    END) = 2;
